# 文件上传进度条定时器功能测试文档

## 测试概述

**创建时间**: 2025-01-13  
**测试目标**: 验证文件上传进度条每1秒自动更新功能  
**相关文件**: `frontEnd/src/hooks/useUpload.ts`

## 功能实现总结

### 已完成的修改

1. **添加定时器状态管理**
   - 导入 `useRef` 和 `useEffect`
   - 添加 `progressTimerRef` 用于存储定时器引用
   - 添加 `currentTaskRef` 用于存储当前上传任务

2. **实现定时器管理函数**
   - `startProgressTimer(task)`: 启动定时器，每1秒调用 `updateProgress`
   - `stopProgressTimer()`: 停止并清理定时器
   - `useEffect` 清理逻辑：组件卸载时自动清理定时器

3. **集成定时器与上传生命周期**
   - **启动时机**:
     - `_uploadSmallFile`: 设置状态为 `Uploading` 后启动定时器
     - `_uploadChunkedFile`: 设置状态为 `Uploading` 后启动定时器
   - **停止时机**:
     - `_uploadSmallFile`: 成功/失败时停止定时器
     - `_uploadChunkedFile`: 秒传时停止定时器
     - `handleUpload`: 错误处理时停止定时器
     - `pauseUpload`: 暂停/中断时停止定时器
     - `finishTask`: 完成时停止定时器

## 测试计划

### 测试场景

#### 1. 小文件上传测试
- **测试文件**: 小于1MB的文件
- **预期行为**: 
  - 上传开始后进度条每1秒更新
  - 上传完成后定时器停止
  - 控制台显示进度更新日志

#### 2. 大文件分片上传测试
- **测试文件**: 大于1MB的文件
- **预期行为**:
  - 分片上传过程中进度条每1秒更新
  - 显示实时的已上传字节数和百分比
  - 文件合并前进度接近100%
  - 合并完成后定时器停止

#### 3. 秒传测试
- **测试文件**: 已存在的文件
- **预期行为**:
  - 检测到文件已存在后立即停止定时器
  - 进度直接跳转到100%

#### 4. 上传暂停/恢复测试
- **测试操作**: 上传过程中暂停，然后恢复
- **预期行为**:
  - 暂停时定时器停止
  - 恢复时重新启动定时器
  - 进度从暂停点继续更新

#### 5. 上传失败测试
- **测试场景**: 网络中断或服务器错误
- **预期行为**:
  - 失败时定时器立即停止
  - 进度条显示错误状态

#### 6. 多文件并发上传测试
- **测试场景**: 同时上传多个文件
- **预期行为**:
  - 每个文件的进度独立更新
  - 定时器正确管理当前活跃的上传任务

### 性能测试

#### 1. 内存泄漏测试
- **测试方法**: 长时间运行，监控内存使用
- **预期结果**: 无内存泄漏，定时器正确清理

#### 2. CPU使用率测试
- **测试方法**: 监控定时器运行时的CPU占用
- **预期结果**: CPU占用率保持在合理范围内

## 验证要点

### 1. 进度更新频率
- [ ] 进度条每1秒更新一次
- [ ] 更新频率稳定，不会过快或过慢

### 2. 进度计算准确性
- [ ] 显示的百分比与实际上传进度一致
- [ ] 已上传字节数计算正确
- [ ] 总文件大小显示正确

### 3. 定时器生命周期管理
- [ ] 上传开始时定时器启动
- [ ] 上传完成时定时器停止
- [ ] 上传失败时定时器停止
- [ ] 上传暂停时定时器停止
- [ ] 组件卸载时定时器清理

### 4. 用户体验
- [ ] 进度条流畅更新，无卡顿
- [ ] 进度信息清晰易懂
- [ ] 不影响上传性能

## 测试步骤

### 准备工作
1. 确保开发环境正常运行
2. 准备不同大小的测试文件
3. 打开浏览器开发者工具，监控控制台和网络

### 执行测试
1. **小文件上传测试**
   ```
   1. 选择小于1MB的文件
   2. 点击上传
   3. 观察进度条是否每1秒更新
   4. 检查控制台进度日志
   5. 确认上传完成后定时器停止
   ```

2. **大文件分片上传测试**
   ```
   1. 选择大于5MB的文件
   2. 点击上传
   3. 观察分片上传过程中的进度更新
   4. 检查进度计算是否准确
   5. 确认合并完成后定时器停止
   ```

3. **暂停恢复测试**
   ```
   1. 开始上传大文件
   2. 上传过程中点击暂停
   3. 确认定时器停止
   4. 点击恢复上传
   5. 确认定时器重新启动
   ```

## 预期结果

### 成功标准
- 进度条每1秒稳定更新
- 进度计算准确，与实际上传状态一致
- 定时器在所有场景下正确启动和停止
- 无内存泄漏或性能问题
- 用户体验流畅，无明显卡顿

### 问题排查
如果测试中发现问题，检查以下方面：
1. 定时器是否正确启动和清理
2. `updateProgress` 函数是否正确计算进度
3. 事件回调是否正确触发
4. 控制台是否有错误信息

## 风险评估

### 低风险
- 定时器频率设置为1秒，对性能影响较小
- 使用 `useRef` 和 `useEffect` 进行标准的React状态管理

### 中等风险
- 多文件并发上传时的定时器管理
- 网络不稳定情况下的进度计算

### 缓解措施
- 严格的定时器清理机制
- 完善的错误处理
- 组件卸载时的资源清理

## 后续优化建议

1. **动态调整更新频率**: 根据上传速度动态调整进度更新频率
2. **进度平滑过渡**: 添加进度条动画，使更新更加平滑
3. **性能监控**: 添加性能监控指标，实时监控定时器影响
4. **用户配置**: 允许用户自定义进度更新频率

---

**测试负责人**: AI Assistant  
**文档版本**: 1.0  
**最后更新**: 2025-01-13