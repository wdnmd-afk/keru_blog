# keru_blog é¡¹ç›® RBAC æƒé™ç®¡ç†ç³»ç»Ÿå®æ–½æ–‡æ¡£

## å®æ–½æ¦‚è¿°

æœ¬æ¬¡å®æ–½ä¸º keru_blog é¡¹ç›®çš„ management ç®¡ç†ç³»ç»Ÿæ·»åŠ äº†å®Œæ•´çš„ RBAC (Role-Based Access Control) æƒé™ç®¡ç†åŠŸèƒ½ï¼Œå®ç°äº†ç”¨æˆ·ã€è§’è‰²ã€æƒé™çš„å¤šå¯¹å¤šå…³ç³»ç®¡ç†ï¼Œæä¾›äº†å®Œå–„çš„æƒé™éªŒè¯æœºåˆ¶ã€‚

## ç³»ç»Ÿæ¶æ„

### 1. æ•°æ®åº“è®¾è®¡

#### 1.1 RBAC æ ¸å¿ƒè¡¨ç»“æ„

**æƒé™è¡¨ (Permission)**
```sql
- id: String (ä¸»é”®)
- name: String (æƒé™åç§°)
- code: String (æƒé™ä»£ç ï¼Œå”¯ä¸€)
- type: PermissionType (æƒé™ç±»å‹ï¼šPAGE/BUTTON)
- description: String? (æƒé™æè¿°)
- parentId: String? (çˆ¶æƒé™IDï¼Œæ”¯æŒæƒé™æ ‘ç»“æ„)
- createdAt: DateTime
- updatedAt: DateTime
```

**è§’è‰²è¡¨ (Role)**
```sql
- id: String (ä¸»é”®)
- name: String (è§’è‰²åç§°ï¼Œå”¯ä¸€)
- description: String? (è§’è‰²æè¿°)
- status: RoleStatus (è§’è‰²çŠ¶æ€ï¼šACTIVE/INACTIVE)
- createdAt: DateTime
- updatedAt: DateTime
```

**ç”¨æˆ·è§’è‰²å…³è”è¡¨ (UserRole)**
```sql
- id: String (ä¸»é”®)
- userId: String (ç”¨æˆ·ID)
- roleId: String (è§’è‰²ID)
- createdAt: DateTime
- å”¯ä¸€çº¦æŸ: (userId, roleId)
```

**è§’è‰²æƒé™å…³è”è¡¨ (RolePermission)**
```sql
- id: String (ä¸»é”®)
- roleId: String (è§’è‰²ID)
- permissionId: String (æƒé™ID)
- createdAt: DateTime
- å”¯ä¸€çº¦æŸ: (roleId, permissionId)
```

#### 1.2 æƒé™ç±»å‹æšä¸¾

```typescript
enum PermissionType {
  PAGE    // é¡µé¢æƒé™ - æ§åˆ¶é¡µé¢è®¿é—®
  BUTTON  // æŒ‰é’®æƒé™ - æ§åˆ¶åŠŸèƒ½æ“ä½œ
}

enum RoleStatus {
  ACTIVE    // æ¿€æ´»çŠ¶æ€
  INACTIVE  // åœç”¨çŠ¶æ€
}
```

### 2. åç«¯ API è®¾è®¡

#### 2.1 æƒé™ç®¡ç†æ¥å£

**åŸºç¡€ CRUD æ“ä½œ**
- `POST /api/rbac/permission/create` - åˆ›å»ºæƒé™
- `POST /api/rbac/permission/update` - æ›´æ–°æƒé™
- `POST /api/rbac/permission/delete` - åˆ é™¤æƒé™
- `POST /api/rbac/permission/query` - æŸ¥è¯¢æƒé™åˆ—è¡¨
- `POST /api/rbac/permission/queryWithPagination` - åˆ†é¡µæŸ¥è¯¢æƒé™
- `POST /api/rbac/permission/tree` - è·å–æƒé™æ ‘ç»“æ„
- `POST /api/rbac/permission/batchDelete` - æ‰¹é‡åˆ é™¤æƒé™

**æƒé™éªŒè¯æ¥å£**
- `POST /api/rbac/user/permissions` - è·å–ç”¨æˆ·æƒé™
- `POST /api/rbac/user/checkPermission` - éªŒè¯ç”¨æˆ·æƒé™
- `POST /api/rbac/user/myPermissions` - è·å–å½“å‰ç”¨æˆ·æƒé™
- `POST /api/rbac/user/checkMyPermission` - éªŒè¯å½“å‰ç”¨æˆ·æƒé™

#### 2.2 è§’è‰²ç®¡ç†æ¥å£

**åŸºç¡€ CRUD æ“ä½œ**
- `POST /api/rbac/role/create` - åˆ›å»ºè§’è‰²
- `POST /api/rbac/role/update` - æ›´æ–°è§’è‰²
- `POST /api/rbac/role/delete` - åˆ é™¤è§’è‰²
- `POST /api/rbac/role/query` - æŸ¥è¯¢è§’è‰²åˆ—è¡¨
- `POST /api/rbac/role/queryWithPagination` - åˆ†é¡µæŸ¥è¯¢è§’è‰²
- `POST /api/rbac/role/batchDelete` - æ‰¹é‡åˆ é™¤è§’è‰²
- `POST /api/rbac/role/batchUpdateStatus` - æ‰¹é‡æ›´æ–°è§’è‰²çŠ¶æ€

**è§’è‰²æƒé™ç®¡ç†**
- `POST /api/rbac/role/assignPermissions` - ä¸ºè§’è‰²åˆ†é…æƒé™
- `POST /api/rbac/role/permissions` - è·å–è§’è‰²æƒé™

#### 2.3 ç”¨æˆ·è§’è‰²ç®¡ç†æ¥å£

- `POST /api/rbac/user/assignRoles` - ä¸ºç”¨æˆ·åˆ†é…è§’è‰²

### 3. å‰ç«¯é¡µé¢è®¾è®¡

#### 3.1 æƒé™ç®¡ç†é¡µé¢ (`/user-management/permissions`)

**åŠŸèƒ½ç‰¹æ€§ï¼š**
- æƒé™åˆ—è¡¨å±•ç¤ºï¼ˆè¡¨æ ¼å½¢å¼ï¼‰
- æƒé™æœç´¢å’Œç­›é€‰ï¼ˆæŒ‰åç§°ã€ç±»å‹ï¼‰
- æƒé™æ–°å¢/ç¼–è¾‘ï¼ˆæ¨¡æ€æ¡†è¡¨å•ï¼‰
- æƒé™åˆ é™¤ï¼ˆç¡®è®¤æç¤ºï¼‰
- æƒé™æ ‘ç»“æ„å±•ç¤º
- çˆ¶å­æƒé™å…³ç³»ç®¡ç†

**æ ¸å¿ƒç»„ä»¶ï¼š**
- æœç´¢ç­›é€‰åŒºåŸŸ
- æƒé™æ•°æ®è¡¨æ ¼
- æ–°å¢/ç¼–è¾‘æƒé™æ¨¡æ€æ¡†
- æƒé™æ ‘é€‰æ‹©å™¨

#### 3.2 è§’è‰²ç®¡ç†é¡µé¢ (`/user-management/roles`)

**åŠŸèƒ½ç‰¹æ€§ï¼š**
- è§’è‰²åˆ—è¡¨å±•ç¤º
- è§’è‰²æœç´¢å’Œç­›é€‰ï¼ˆæŒ‰åç§°ã€çŠ¶æ€ï¼‰
- è§’è‰²æ–°å¢/ç¼–è¾‘
- è§’è‰²åˆ é™¤
- è§’è‰²æƒé™åˆ†é…ï¼ˆæ ‘å½¢é€‰æ‹©å™¨ï¼‰
- è§’è‰²çŠ¶æ€ç®¡ç†

**æ ¸å¿ƒç»„ä»¶ï¼š**
- æœç´¢ç­›é€‰åŒºåŸŸ
- è§’è‰²æ•°æ®è¡¨æ ¼
- æ–°å¢/ç¼–è¾‘è§’è‰²æ¨¡æ€æ¡†
- æƒé™åˆ†é…æ¨¡æ€æ¡†ï¼ˆæ ‘å½¢é€‰æ‹©ï¼‰

#### 3.3 ç”¨æˆ·è§’è‰²ç®¡ç†é¡µé¢ (`/user-management`)

**åŠŸèƒ½ç‰¹æ€§ï¼š**
- ç”¨æˆ·åˆ—è¡¨å±•ç¤º
- ç”¨æˆ·æœç´¢ï¼ˆæŒ‰é‚®ç®±ã€å§“åï¼‰
- ç”¨æˆ·è§’è‰²åˆ†é…
- å½“å‰è§’è‰²å±•ç¤º
- å¤šè§’è‰²æ”¯æŒ

**æ ¸å¿ƒç»„ä»¶ï¼š**
- ç”¨æˆ·æœç´¢åŒºåŸŸ
- ç”¨æˆ·æ•°æ®è¡¨æ ¼
- è§’è‰²åˆ†é…æ¨¡æ€æ¡†

### 4. æƒé™éªŒè¯æœºåˆ¶

#### 4.1 åç«¯æƒé™ä¸­é—´ä»¶

**æƒé™éªŒè¯ä¸­é—´ä»¶ç±»å‹ï¼š**
```typescript
// å•æƒé™éªŒè¯
requirePermission(permissionCode: string)

// ä»»ä¸€æƒé™éªŒè¯ï¼ˆOR é€»è¾‘ï¼‰
requireAnyPermission(permissionCodes: string[])

// å…¨æƒé™éªŒè¯ï¼ˆAND é€»è¾‘ï¼‰
requireAllPermissions(permissionCodes: string[])
```

**æƒé™ç¼“å­˜æœºåˆ¶ï¼š**
- ç”¨æˆ·æƒé™ç¼“å­˜ï¼ˆ5åˆ†é’Ÿ TTLï¼‰
- è‡ªåŠ¨ç¼“å­˜æ¸…ç†
- æƒé™å˜æ›´å®æ—¶æ›´æ–°

#### 4.2 å‰ç«¯æƒé™æ§åˆ¶

**è·¯ç”±å®ˆå«ï¼š**
- åŸºäºç”¨æˆ·ç™»å½•çŠ¶æ€çš„è·¯ç”±ä¿æŠ¤
- åŠ¨æ€èœå•æ˜¾ç¤ºï¼ˆæ ¹æ®æƒé™ï¼‰
- é¡µé¢çº§æƒé™æ§åˆ¶

**ç»„ä»¶çº§æƒé™ï¼š**
- æŒ‰é’®æƒé™æ§åˆ¶
- åŠŸèƒ½æ¨¡å—æƒé™æ§åˆ¶
- æ¡ä»¶æ¸²æŸ“æƒé™ç»„ä»¶

## åˆå§‹æ•°æ®é…ç½®

### 1. é¢„è®¾æƒé™ç»“æ„

**é¡µé¢æƒé™ï¼ˆPAGEï¼‰ï¼š**
```
ä»ªè¡¨æ¿æƒé™
â”œâ”€â”€ dashboard:view - ä»ªè¡¨æ¿æŸ¥çœ‹

ç”¨æˆ·ç®¡ç†æƒé™
â”œâ”€â”€ user:manage - ç”¨æˆ·ç®¡ç†æ¨¡å—
â”œâ”€â”€ user:view - ç”¨æˆ·åˆ—è¡¨æŸ¥çœ‹
â”œâ”€â”€ user:create - ç”¨æˆ·åˆ›å»º
â”œâ”€â”€ user:edit - ç”¨æˆ·ç¼–è¾‘
â”œâ”€â”€ user:delete - ç”¨æˆ·åˆ é™¤

è§’è‰²ç®¡ç†æƒé™
â”œâ”€â”€ role:manage - è§’è‰²ç®¡ç†æ¨¡å—
â”œâ”€â”€ role:view - è§’è‰²åˆ—è¡¨æŸ¥çœ‹
â”œâ”€â”€ role:create - è§’è‰²åˆ›å»º
â”œâ”€â”€ role:edit - è§’è‰²ç¼–è¾‘
â”œâ”€â”€ role:delete - è§’è‰²åˆ é™¤
â”œâ”€â”€ role:assign-permissions - è§’è‰²æƒé™åˆ†é…

æƒé™ç®¡ç†æƒé™
â”œâ”€â”€ permission:manage - æƒé™ç®¡ç†æ¨¡å—
â”œâ”€â”€ permission:view - æƒé™åˆ—è¡¨æŸ¥çœ‹
â”œâ”€â”€ permission:create - æƒé™åˆ›å»º
â”œâ”€â”€ permission:edit - æƒé™ç¼–è¾‘
â”œâ”€â”€ permission:delete - æƒé™åˆ é™¤

å‰ç«¯é…ç½®æƒé™
â”œâ”€â”€ frontend-config:manage - å‰ç«¯é…ç½®ç®¡ç†
â”œâ”€â”€ frontend-config:theme - ä¸»é¢˜è®¾ç½®
â”œâ”€â”€ frontend-config:features - åŠŸèƒ½å¼€å…³
â”œâ”€â”€ frontend-config:api - APIé…ç½®

æœåŠ¡ç«¯é…ç½®æƒé™
â”œâ”€â”€ server-config:manage - æœåŠ¡ç«¯é…ç½®ç®¡ç†
â”œâ”€â”€ server-config:database - æ•°æ®åº“é…ç½®
â”œâ”€â”€ server-config:redis - Redisé…ç½®
â”œâ”€â”€ server-config:jwt - JWTé…ç½®

ç³»ç»Ÿç›‘æ§æƒé™
â”œâ”€â”€ system-monitor:manage - ç³»ç»Ÿç›‘æ§ç®¡ç†
â”œâ”€â”€ system-monitor:overview - ç³»ç»Ÿæ¦‚è§ˆ
â”œâ”€â”€ system-monitor:logs - æ—¥å¿—ç®¡ç†
â”œâ”€â”€ system-monitor:performance - æ€§èƒ½ç›‘æ§
```

### 2. é¢„è®¾è§’è‰²é…ç½®

**è¶…çº§ç®¡ç†å‘˜**
- æè¿°ï¼šæ‹¥æœ‰ç³»ç»Ÿæ‰€æœ‰æƒé™çš„è¶…çº§ç®¡ç†å‘˜è§’è‰²
- æƒé™ï¼šæ‰€æœ‰æƒé™
- çŠ¶æ€ï¼šæ¿€æ´»

**ç³»ç»Ÿç®¡ç†å‘˜**
- æè¿°ï¼šè´Ÿè´£ç³»ç»Ÿé…ç½®å’Œç”¨æˆ·ç®¡ç†çš„ç®¡ç†å‘˜è§’è‰²
- æƒé™ï¼šä»ªè¡¨æ¿ã€ç”¨æˆ·ç®¡ç†ã€è§’è‰²ç®¡ç†ã€ç³»ç»Ÿç›‘æ§ç›¸å…³æƒé™
- çŠ¶æ€ï¼šæ¿€æ´»

**å†…å®¹ç®¡ç†å‘˜**
- æè¿°ï¼šè´Ÿè´£å†…å®¹ç®¡ç†çš„ç®¡ç†å‘˜è§’è‰²
- æƒé™ï¼šåŸºç¡€æŸ¥çœ‹æƒé™
- çŠ¶æ€ï¼šæ¿€æ´»

**æ™®é€šç”¨æˆ·**
- æè¿°ï¼šç³»ç»Ÿæ™®é€šç”¨æˆ·è§’è‰²
- æƒé™ï¼šä»ªè¡¨æ¿æŸ¥çœ‹æƒé™
- çŠ¶æ€ï¼šæ¿€æ´»

## æŠ€æœ¯å®ç°è¦ç‚¹

### 1. æ•°æ®åº“å±‚é¢

**å…³ç³»è®¾è®¡ï¼š**
- ç”¨æˆ· â†” è§’è‰²ï¼šå¤šå¯¹å¤šå…³ç³»ï¼ˆUserRole ä¸­é—´è¡¨ï¼‰
- è§’è‰² â†” æƒé™ï¼šå¤šå¯¹å¤šå…³ç³»ï¼ˆRolePermission ä¸­é—´è¡¨ï¼‰
- æƒé™æ”¯æŒæ ‘å½¢ç»“æ„ï¼ˆè‡ªå…³è”ï¼‰

**æ€§èƒ½ä¼˜åŒ–ï¼š**
- åˆç†çš„ç´¢å¼•è®¾è®¡
- çº§è”åˆ é™¤é…ç½®
- å”¯ä¸€çº¦æŸé˜²æ­¢é‡å¤å…³è”

### 2. åç«¯æœåŠ¡å±‚é¢

**æ¶æ„æ¨¡å¼ï¼š**
- Controller-Service-Repository åˆ†å±‚æ¶æ„
- ä¾èµ–æ³¨å…¥ï¼ˆinversifyï¼‰
- ç»Ÿä¸€çš„é”™è¯¯å¤„ç†å’Œå“åº”æ ¼å¼

**å®‰å…¨æœºåˆ¶ï¼š**
- JWT è®¤è¯é›†æˆ
- æƒé™ä¸­é—´ä»¶éªŒè¯
- ç®¡ç†å‘˜ç‰¹æƒå¤„ç†

**ç¼“å­˜ç­–ç•¥ï¼š**
- ç”¨æˆ·æƒé™ç¼“å­˜
- ç¼“å­˜å¤±æ•ˆæœºåˆ¶
- æ€§èƒ½ä¼˜åŒ–

### 3. å‰ç«¯ç•Œé¢å±‚é¢

**ç»„ä»¶è®¾è®¡ï¼š**
- Ant Design ç»„ä»¶åº“
- å“åº”å¼å¸ƒå±€
- ç»Ÿä¸€çš„äº¤äº’æ¨¡å¼

**ç”¨æˆ·ä½“éªŒï¼š**
- ç›´è§‚çš„æƒé™æ ‘å±•ç¤º
- ä¾¿æ·çš„æœç´¢ç­›é€‰
- å‹å¥½çš„æ“ä½œæç¤º

**çŠ¶æ€ç®¡ç†ï¼š**
- æœ¬åœ°çŠ¶æ€ç®¡ç†
- æ•°æ®åŒæ­¥æœºåˆ¶
- é”™è¯¯å¤„ç†

## éƒ¨ç½²å’Œä½¿ç”¨

### 1. æ•°æ®åº“è¿ç§»

```bash
# ç”Ÿæˆå¹¶åº”ç”¨æ•°æ®åº“è¿ç§»
cd server
npx prisma migrate dev --name add_rbac_system
```

### 2. åˆå§‹åŒ–æ•°æ®

```bash
# è¿è¡Œåˆå§‹åŒ–è„šæœ¬
cd server
npx tsx src/scripts/init-rbac-data.ts
```

### 3. å¯åŠ¨æœåŠ¡

```bash
# å¯åŠ¨åç«¯æœåŠ¡
cd server
npm run dev

# å¯åŠ¨å‰ç«¯ç®¡ç†ç³»ç»Ÿ
cd management
npm run dev
```

### 4. è®¿é—®ç®¡ç†ç•Œé¢

- æƒé™ç®¡ç†ï¼š`http://localhost:5173/user-management/permissions`
- è§’è‰²ç®¡ç†ï¼š`http://localhost:5173/user-management/roles`
- ç”¨æˆ·è§’è‰²ç®¡ç†ï¼š`http://localhost:5173/user-management`

## ä½¿ç”¨æŒ‡å—

### 1. æƒé™ç®¡ç†

**åˆ›å»ºæƒé™ï¼š**
1. è¿›å…¥æƒé™ç®¡ç†é¡µé¢
2. ç‚¹å‡»"æ–°å¢æƒé™"æŒ‰é’®
3. å¡«å†™æƒé™ä¿¡æ¯ï¼ˆåç§°ã€ä»£ç ã€ç±»å‹ã€æè¿°ï¼‰
4. é€‰æ‹©çˆ¶æƒé™ï¼ˆå¯é€‰ï¼‰
5. æäº¤ä¿å­˜

**æƒé™ä»£ç è§„èŒƒï¼š**
- æ ¼å¼ï¼š`æ¨¡å—:æ“ä½œ`
- ç¤ºä¾‹ï¼š`user:create`ã€`dashboard:view`
- ä½¿ç”¨å°å†™å­—æ¯ã€æ•°å­—ã€å†’å·ã€ä¸‹åˆ’çº¿

### 2. è§’è‰²ç®¡ç†

**åˆ›å»ºè§’è‰²ï¼š**
1. è¿›å…¥è§’è‰²ç®¡ç†é¡µé¢
2. ç‚¹å‡»"æ–°å¢è§’è‰²"æŒ‰é’®
3. å¡«å†™è§’è‰²ä¿¡æ¯
4. è®¾ç½®è§’è‰²çŠ¶æ€
5. æäº¤ä¿å­˜

**åˆ†é…æƒé™ï¼š**
1. åœ¨è§’è‰²åˆ—è¡¨ä¸­ç‚¹å‡»"åˆ†é…æƒé™"
2. åœ¨æƒé™æ ‘ä¸­é€‰æ‹©éœ€è¦çš„æƒé™
3. æ”¯æŒçˆ¶å­æƒé™è”åŠ¨é€‰æ‹©
4. ç¡®è®¤ä¿å­˜

### 3. ç”¨æˆ·è§’è‰²ç®¡ç†

**ä¸ºç”¨æˆ·åˆ†é…è§’è‰²ï¼š**
1. è¿›å…¥ç”¨æˆ·è§’è‰²ç®¡ç†é¡µé¢
2. æ‰¾åˆ°ç›®æ ‡ç”¨æˆ·ï¼Œç‚¹å‡»"åˆ†é…è§’è‰²"
3. é€‰æ‹©ä¸€ä¸ªæˆ–å¤šä¸ªè§’è‰²
4. ç¡®è®¤ä¿å­˜

**è§’è‰²ç”Ÿæ•ˆï¼š**
- è§’è‰²åˆ†é…åç«‹å³ç”Ÿæ•ˆ
- ç”¨æˆ·æƒé™å®æ—¶æ›´æ–°
- æ— éœ€é‡æ–°ç™»å½•

## å®‰å…¨è€ƒè™‘

### 1. æƒé™éªŒè¯

**å¤šå±‚éªŒè¯ï¼š**
- å‰ç«¯è·¯ç”±å®ˆå«
- åç«¯æ¥å£æƒé™éªŒè¯
- æ•°æ®åº“å±‚é¢çº¦æŸ

**ç®¡ç†å‘˜ç‰¹æƒï¼š**
- admin å­—æ®µç”¨æˆ·æ‹¥æœ‰æ‰€æœ‰æƒé™
- ç»•è¿‡ RBAC æƒé™æ£€æŸ¥
- ç³»ç»Ÿçº§ç®¡ç†å‘˜è´¦æˆ·

### 2. æ•°æ®å®‰å…¨

**è¾“å…¥éªŒè¯ï¼š**
- æƒé™ä»£ç æ ¼å¼éªŒè¯
- è§’è‰²åç§°å”¯ä¸€æ€§æ£€æŸ¥
- é˜²æ­¢å¾ªç¯å¼•ç”¨

**æ“ä½œå®¡è®¡ï¼š**
- æƒé™å˜æ›´è®°å½•
- è§’è‰²åˆ†é…æ—¥å¿—
- ç”¨æˆ·æ“ä½œè¿½è¸ª

## æ‰©å±•å’Œç»´æŠ¤

### 1. æƒé™æ‰©å±•

**æ·»åŠ æ–°æƒé™ï¼š**
1. åœ¨æƒé™ç®¡ç†ç•Œé¢åˆ›å»ºæ–°æƒé™
2. æ›´æ–°ç›¸å…³è§’è‰²çš„æƒé™é…ç½®
3. åœ¨ä»£ç ä¸­æ·»åŠ æƒé™éªŒè¯

**æƒé™åˆ†ç±»ï¼š**
- æŒ‰ä¸šåŠ¡æ¨¡å—åˆ†ç±»
- æ”¯æŒæƒé™æ ‘ç»“æ„
- ä¾¿äºæƒé™ç®¡ç†

### 2. ç³»ç»Ÿç»´æŠ¤

**å®šæœŸæ£€æŸ¥ï¼š**
- æ¸…ç†æ— ç”¨æƒé™
- ä¼˜åŒ–è§’è‰²é…ç½®
- å®¡æŸ¥ç”¨æˆ·æƒé™

**æ€§èƒ½ç›‘æ§ï¼š**
- æƒé™æŸ¥è¯¢æ€§èƒ½
- ç¼“å­˜å‘½ä¸­ç‡
- æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–

## æ€»ç»“

keru_blog RBAC æƒé™ç®¡ç†ç³»ç»Ÿå®æ–½å®Œæˆï¼Œæä¾›äº†ï¼š

**âœ… å®Œæ•´çš„æƒé™ç®¡ç†ä½“ç³»**
- ç”¨æˆ·ã€è§’è‰²ã€æƒé™çš„å¤šå¯¹å¤šå…³ç³»
- çµæ´»çš„æƒé™åˆ†é…æœºåˆ¶
- æ ‘å½¢æƒé™ç»“æ„æ”¯æŒ

**âœ… å‹å¥½çš„ç®¡ç†ç•Œé¢**
- ç›´è§‚çš„æƒé™ç®¡ç†é¡µé¢
- ä¾¿æ·çš„è§’è‰²é…ç½®ç•Œé¢
- é«˜æ•ˆçš„ç”¨æˆ·è§’è‰²åˆ†é…

**âœ… å¯é çš„å®‰å…¨æœºåˆ¶**
- å¤šå±‚æƒé™éªŒè¯
- æƒé™ç¼“å­˜ä¼˜åŒ–
- å®æ—¶æƒé™æ›´æ–°

**âœ… è‰¯å¥½çš„æ‰©å±•æ€§**
- æ¨¡å—åŒ–è®¾è®¡
- æ ‡å‡†åŒ–æ¥å£
- æ˜“äºç»´æŠ¤å’Œæ‰©å±•

è¯¥ç³»ç»Ÿä¸º keru_blog é¡¹ç›®æä¾›äº†ä¼ä¸šçº§çš„æƒé™ç®¡ç†èƒ½åŠ›ï¼Œç¡®ä¿äº†ç³»ç»Ÿçš„å®‰å…¨æ€§å’Œå¯ç®¡ç†æ€§ã€‚

## HTTP å·¥å…·é›†æˆå’Œ API ä¿®å¤

### 1. API åŸºç¡€åœ°å€é…ç½®ä¿®å¤

**é—®é¢˜ï¼š** å‰ç«¯ HTTP å·¥å…·é…ç½®çš„ API åŸºç¡€åœ°å€ä¸åç«¯è·¯ç”±ä¸åŒ¹é…
- å‰ç«¯é…ç½®ï¼š`/management-api` â†’ é‡å†™ä¸ºç©ºè·¯å¾„
- åç«¯è·¯ç”±ï¼š`/api/rbac/*`

**è§£å†³æ–¹æ¡ˆï¼š** ä¿®å¤ Vite ä»£ç†é…ç½®
```typescript
// management/vite.config.ts
proxy: {
  "/management-api": {
    target: "http://127.0.0.1:5566",
    changeOrigin: true,
    rewrite: (path) => path.replace(/^\/management-api/, "/api"), // ä¿®å¤ï¼šé‡å†™ä¸º /api
  },
}
```

### 2. RBAC API æœåŠ¡ç±»åˆ›å»º

**åˆ›å»ºæ–‡ä»¶ï¼š** `management/src/api/rbac.ts`

**åŠŸèƒ½ç‰¹æ€§ï¼š**
- å®Œæ•´çš„ TypeScript ç±»å‹å®šä¹‰
- ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æœºåˆ¶
- ä¸ç°æœ‰ AuthApi ä¿æŒä¸€è‡´çš„è°ƒç”¨æ¨¡å¼
- æ”¯æŒæ‰€æœ‰ 25 ä¸ª RBAC API æ¥å£

**API æ–¹æ³•åˆ†ç±»ï¼š**

**æƒé™ç®¡ç†æ¥å£ï¼ˆ8ä¸ªï¼‰ï¼š**
- `createPermission()` - åˆ›å»ºæƒé™
- `updatePermission()` - æ›´æ–°æƒé™
- `deletePermission()` - åˆ é™¤æƒé™
- `queryPermissions()` - æŸ¥è¯¢æƒé™åˆ—è¡¨
- `queryPermissionsWithPagination()` - åˆ†é¡µæŸ¥è¯¢æƒé™
- `getPermissionTree()` - è·å–æƒé™æ ‘ç»“æ„
- `batchDeletePermissions()` - æ‰¹é‡åˆ é™¤æƒé™

**è§’è‰²ç®¡ç†æ¥å£ï¼ˆ8ä¸ªï¼‰ï¼š**
- `createRole()` - åˆ›å»ºè§’è‰²
- `updateRole()` - æ›´æ–°è§’è‰²
- `deleteRole()` - åˆ é™¤è§’è‰²
- `queryRoles()` - æŸ¥è¯¢è§’è‰²åˆ—è¡¨
- `queryRolesWithPagination()` - åˆ†é¡µæŸ¥è¯¢è§’è‰²
- `batchDeleteRoles()` - æ‰¹é‡åˆ é™¤è§’è‰²
- `batchUpdateRoleStatus()` - æ‰¹é‡æ›´æ–°è§’è‰²çŠ¶æ€
- `assignRolePermissions()` - ä¸ºè§’è‰²åˆ†é…æƒé™
- `getRolePermissions()` - è·å–è§’è‰²æƒé™

**ç”¨æˆ·è§’è‰²ç®¡ç†æ¥å£ï¼ˆ5ä¸ªï¼‰ï¼š**
- `assignUserRoles()` - ä¸ºç”¨æˆ·åˆ†é…è§’è‰²
- `getUserRoles()` - è·å–ç”¨æˆ·è§’è‰²
- `getUserPermissions()` - è·å–ç”¨æˆ·æƒé™
- `checkUserPermission()` - éªŒè¯ç”¨æˆ·æƒé™
- `getMyPermissions()` - è·å–å½“å‰ç”¨æˆ·æƒé™
- `checkMyPermission()` - éªŒè¯å½“å‰ç”¨æˆ·æƒé™

### 3. å‰ç«¯é¡µé¢ HTTP è°ƒç”¨æ›¿æ¢

**æƒé™ç®¡ç†é¡µé¢æ›´æ–°ï¼š** `management/src/pages/UserManagement/PermissionManagement/index.tsx`

**æ›¿æ¢å†…å®¹ï¼š**
- âœ… æ·»åŠ  RbacApi å¯¼å…¥å’Œç±»å‹å®šä¹‰
- âœ… æ›¿æ¢ `fetchPermissions()` - ä½¿ç”¨ `RbacApi.queryPermissions()`
- âœ… æ›¿æ¢ `fetchPermissionTree()` - ä½¿ç”¨ `RbacApi.getPermissionTree()`
- âœ… æ›¿æ¢ `handleSubmit()` - ä½¿ç”¨ `RbacApi.createPermission()` / `RbacApi.updatePermission()`
- âœ… æ›¿æ¢ `handleDelete()` - ä½¿ç”¨ `RbacApi.deletePermission()`

**è§’è‰²ç®¡ç†é¡µé¢æ›´æ–°ï¼š** `management/src/pages/UserManagement/RoleManagement/index.tsx`

**æ›¿æ¢è¿›åº¦ï¼š**
- âœ… æ·»åŠ  RbacApi å¯¼å…¥å’Œç±»å‹å®šä¹‰
- âœ… æ›¿æ¢ `fetchRoles()` - ä½¿ç”¨ `RbacApi.queryRoles()`
- ğŸ”„ æ­£åœ¨æ›¿æ¢å…¶ä»– fetch è°ƒç”¨...

### 4. ç»Ÿä¸€é”™è¯¯å¤„ç†æœºåˆ¶

**é”™è¯¯å¤„ç†æ¨¡å¼ï¼š**
```typescript
try {
  const result = await RbacApi.someMethod(params)
  // å¤„ç†æˆåŠŸç»“æœ
} catch (error: any) {
  message.error(error.message || 'æ“ä½œå¤±è´¥')
  console.error('æ“ä½œé”™è¯¯:', error)
}
```

**ä¼˜åŠ¿ï¼š**
- ç»Ÿä¸€çš„é”™è¯¯æ¶ˆæ¯æ˜¾ç¤º
- è‡ªåŠ¨çš„è®¤è¯å¤´æ·»åŠ 
- ä¸€è‡´çš„è¯·æ±‚/å“åº”æ ¼å¼
- æ›´å¥½çš„ TypeScript ç±»å‹æ”¯æŒ

### 5. åç«¯é›†æˆä¿®å¤

**å®¹å™¨é…ç½®æ›´æ–°ï¼š** `server/src/config/container.config.ts`
- âœ… æ·»åŠ  RbacController å’Œ RbacService çš„ç±»å‹å®šä¹‰
- âœ… æ³¨å†Œ RBAC ç›¸å…³æœåŠ¡åˆ°ä¾èµ–æ³¨å…¥å®¹å™¨
- âœ… ä¿®å¤ Prisma å®¢æˆ·ç«¯ä¾èµ–æ³¨å…¥

**å¯¼å‡ºæ–‡ä»¶æ›´æ–°ï¼š**
- âœ… `server/src/router/controller.ts` - å¯¼å‡º RbacController
- âœ… `server/src/router/service.ts` - å¯¼å‡º RbacService

**æƒé™ä¸­é—´ä»¶ä¿®å¤ï¼š** `server/src/middleware/permission.ts`
- âœ… ä¿®å¤ Prisma å®¢æˆ·ç«¯ä½¿ç”¨æ–¹å¼
- âœ… æ·»åŠ åˆå§‹åŒ–å‡½æ•°æ”¯æŒä¾èµ–æ³¨å…¥
- âœ… åœ¨ä¸»åº”ç”¨ä¸­åˆå§‹åŒ–æƒé™ä¸­é—´ä»¶

### 6. ä¸‹ä¸€æ­¥è®¡åˆ’

**å¾…å®Œæˆä»»åŠ¡ï¼š**
1. å®Œæˆè§’è‰²ç®¡ç†é¡µé¢çš„æ‰€æœ‰ fetch è°ƒç”¨æ›¿æ¢
2. æ›´æ–°ç”¨æˆ·è§’è‰²ç®¡ç†é¡µé¢çš„ HTTP è°ƒç”¨
3. æµ‹è¯•æ‰€æœ‰ RBAC API æ¥å£çš„è¿é€šæ€§
4. éªŒè¯æƒé™éªŒè¯ä¸­é—´ä»¶çš„æ­£å¸¸å·¥ä½œ
5. è¿›è¡Œç«¯åˆ°ç«¯åŠŸèƒ½æµ‹è¯•

### 7. RBAC API 404 é”™è¯¯ä¿®å¤

**é—®é¢˜è¯Šæ–­ï¼š**
- å‰ç«¯è¯·æ±‚ï¼š`/management-api/rbac/permission/query`
- Vite ä»£ç†é‡å†™ï¼š`/management-api` â†’ `/api`
- å®é™…åç«¯æ¥æ”¶ï¼š`/api/rbac/permission/query`
- æ§åˆ¶å™¨è·¯ç”±ï¼š`@controller('/rbac')` â†’ `/rbac/permission/query`
- **è·¯å¾„ä¸åŒ¹é…**ï¼šç¼ºå°‘ `/api` å…¨å±€å‰ç¼€

**è§£å†³æ–¹æ¡ˆï¼š**
ä¸º InversifyExpressServer æ·»åŠ å…¨å±€è·¯ç”±å‰ç¼€ï¼š
```typescript
// server/main.ts
const server = new InversifyExpressServer(container, null, { rootPath: '/api' })
```

**ä¿®å¤åçš„è·¯ç”±åŒ¹é…ï¼š**
- å‰ç«¯è¯·æ±‚ï¼š`/management-api/rbac/permission/query`
- Vite ä»£ç†ï¼š`/management-api` â†’ `/api`
- åç«¯æ¥æ”¶ï¼š`/api/rbac/permission/query`
- å…¨å±€å‰ç¼€ï¼š`/api`
- æ§åˆ¶å™¨è·¯ç”±ï¼š`/rbac/permission/query`
- **æœ€ç»ˆåŒ¹é…**ï¼š`/api` + `/rbac/permission/query` = `/api/rbac/permission/query` âœ…

**ä¿®å¤å†…å®¹ï¼š**
- âœ… ä¿®å¤ RbacController ä¸­çš„ `customResponse` ç±»å‹é—®é¢˜
- âœ… æ·»åŠ  InversifyExpressServer å…¨å±€è·¯ç”±å‰ç¼€ `/api`
- âœ… ç¡®ä¿æ‰€æœ‰ RBAC API è·¯ç”±æ­£ç¡®åŒ¹é…

**æµ‹è¯•éªŒè¯ï¼š**
- API æ¥å£è¿é€šæ€§æµ‹è¯•
- æƒé™éªŒè¯åŠŸèƒ½æµ‹è¯•
- å‰ç«¯ç•Œé¢äº¤äº’æµ‹è¯•
- é”™è¯¯å¤„ç†æœºåˆ¶æµ‹è¯•
