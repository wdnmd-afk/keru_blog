# Monorepo架构重构实施计划

## 项目背景

将当前的多项目架构重构为monorepo模式，实现更好的代码复用、依赖管理和构建优化。

## 目标架构

```
keru_blog/
├── package.json                 # 根目录依赖管理
├── pnpm-workspace.yaml         # workspace配置
├── tsconfig.json               # 基础TypeScript配置
├── shared/                     # 共享代码目录
│   ├── components/             # 共享组件
│   ├── utils/                  # 共享工具函数
│   ├── types/                  # 共享类型定义
│   ├── styles/                 # 共享样式
│   └── package.json            # shared包配置
├── apps/                       # 应用目录
│   ├── frontend/               # 前端应用
│   ├── management/             # 管理系统
│   └── server/                 # 后端服务
└── tools/                      # 开发工具
```

## 实施阶段

### 阶段1：建立Monorepo基础架构（第1周）

#### 步骤1.1：配置pnpm workspace
- [x] 分析当前项目结构和依赖关系
- [ ] 创建pnpm-workspace.yaml配置文件
- [ ] 更新根目录package.json，添加workspace配置
- [ ] 重新组织项目目录结构

#### 步骤1.2：创建shared目录结构
- [ ] 创建shared目录和子目录结构
- [ ] 设置shared/package.json配置
- [ ] 创建基础的导出索引文件
- [ ] 配置shared目录的构建工具

#### 步骤1.3：设置根目录基础配置
- [ ] 创建根目录tsconfig.json基础配置
- [ ] 统一代码格式化配置（prettier、eslint）
- [ ] 更新根目录脚本命令
- [ ] 配置开发工具和CI/CD脚本

### 阶段2：依赖管理重构（第2周）

#### 步骤2.1：依赖分析和分类
**公共依赖（提升到根目录）**：
- React生态：react, react-dom, @types/react, @types/react-dom
- 构建工具：vite, typescript, @vitejs/plugin-react
- 代码质量：eslint, prettier, @typescript-eslint/*
- UI组件：antd, @ant-design/icons
- 工具库：axios, dayjs, lodash

**项目特有依赖（保留在子项目）**：
- Frontend特有：mermaid, katex, d3, pdfjs-dist
- Management特有：特定的管理系统组件
- Server特有：express, prisma, inversify等后端依赖

#### 步骤2.2：重构依赖配置
- [ ] 将公共依赖移动到根目录package.json
- [ ] 更新子项目package.json，移除重复依赖
- [ ] 配置依赖版本锁定和提升策略
- [ ] 处理版本冲突和兼容性问题

#### 步骤2.3：验证依赖管理
- [ ] 删除所有node_modules和lock文件
- [ ] 重新安装依赖：`pnpm install`
- [ ] 测试各项目的构建和运行
- [ ] 解决依赖相关的问题

### 阶段3：共享代码迁移（第3周）

#### 步骤3.1：迁移KTable组件
**优先级：高**
- [ ] 将KTable组件迁移到shared/components/KTable
- [ ] 迁移相关样式文件到shared/styles
- [ ] 迁移依赖的工具函数（memoComparator）
- [ ] 更新组件导入路径
- [ ] 测试组件功能完整性

#### 步骤3.2：迁移其他通用组件
**优先级：中**
- [ ] 识别其他可复用组件（SvgIcon、EmptyContainer等）
- [ ] 逐步迁移到shared/components
- [ ] 统一组件API设计
- [ ] 建立组件文档和使用指南

#### 步骤3.3：迁移工具函数和类型
**优先级：中**
- [ ] 迁移通用工具函数到shared/utils
- [ ] 迁移公共类型定义到shared/types
- [ ] 建立统一的API接口类型
- [ ] 创建导出索引文件

### 阶段4：构建配置优化（第4周）

#### 步骤4.1：优化TypeScript配置
- [ ] 设置tsconfig继承关系
- [ ] 配置路径映射支持shared目录
- [ ] 优化编译性能和类型检查
- [ ] 统一代码风格和规范

#### 步骤4.2：更新构建配置
- [ ] 更新各项目的vite.config.ts
- [ ] 配置shared目录的别名和解析
- [ ] 优化构建性能和代码分割
- [ ] 配置开发服务器和热更新

#### 步骤4.3：测试和验证
- [ ] 全面测试各项目功能
- [ ] 验证构建和部署流程
- [ ] 性能测试和优化
- [ ] 文档更新和团队培训

## 风险评估与缓解

### 主要风险
1. **依赖冲突**：不同项目的依赖版本可能不兼容
2. **构建复杂度**：monorepo的构建配置更复杂
3. **迁移成本**：大量代码需要重新组织和测试
4. **团队适应**：开发流程和工具链的变化

### 缓解措施
1. **渐进式迁移**：分阶段实施，每个阶段都充分测试
2. **版本锁定**：使用精确的版本号避免意外升级
3. **充分测试**：每个步骤都进行功能和性能测试
4. **文档完善**：详细记录变更和使用指南
5. **回滚准备**：保留原有配置的备份

## 预期收益

### 短期收益
- 减少重复依赖，节省50%以上的磁盘空间
- 统一版本管理，避免版本冲突
- 简化开发环境搭建流程

### 长期收益
- 更好的代码复用和共享
- 统一的构建和部署流程
- 提高开发效率和代码质量
- 支持更多项目的快速创建

## 成功指标

1. **功能完整性**：所有现有功能正常运行
2. **构建性能**：构建时间不超过原来的120%
3. **依赖优化**：总依赖大小减少40%以上
4. **开发体验**：热更新和类型检查正常工作
5. **代码复用**：至少3个组件实现跨项目复用

## 下一步行动

1. **立即开始**：创建pnpm-workspace.yaml和shared目录结构
2. **本周完成**：阶段1的所有配置和基础架构
3. **持续监控**：每个阶段都进行充分的测试和验证
4. **团队沟通**：及时同步进展和问题，确保团队理解新的工作流程
