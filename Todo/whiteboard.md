# 实时协作白板 TODO（React + Yjs + WebSocket）

## 目标
- 多人在线白板：画笔、撤销/重做、粘贴/拖拽图片、实时评论/标注、缩放/平移。
- 低延迟同步（<150ms 端到端）、断网可离线协作与自动合并、冲突无感（CRDT）。

## 技术栈
- 前端：React + Vite + TypeScript + Zustand
- 协同：Yjs + y-websocket（或自建 provider）+ Awareness
- 绘制：Canvas 2D（必要时 OffscreenCanvas）或 React-Konva
- 传输：WebSocket（心跳/重连/粘包处理）
- 存储：IndexedDB（离线快照）+ 服务器快照/增量日志

## 关键难点
- Canvas 性能：大笔画/多图片场景下保持流畅（60fps）。
- CRDT 合并：多端频繁操作下的一致性与可回放性。
- 低延迟：网络抖动时的预测/回滚与重放。

## 里程碑
- M0 初始化与基础设施
- M1 画笔/图形基础编辑
- M2 协同与冲突解决（Yjs 文档结构/awareness）
- M3 图片粘贴/拖拽与选择框/变换
- M4 评论/标注与权限
- M5 性能优化与离线/快照/回放
- M6 导出/发布

## 任务清单
- **[M0 项目初始化]**
  - [ ] Vite+React+TS 基础工程、ESLint/Prettier/Husky
  - [ ] 主题/样式系统与基础布局（侧栏/画布/工具条）
  - [ ] WebSocket 服务脚手架与本地启动文档
  - [ ] 集成 Yjs 与 provider，搭建最小共享文档
- **[M1 画笔/图形]**
  - [ ] 画笔（压感/平滑/橡皮擦/颜色/粗细/分层）
  - [ ] 图形元素（矩形/圆/直线/箭头）与对齐/吸附
  - [ ] 撤销/重做（本地）与跨端一致性策略
- **[M2 协同/CRDT]**
  - [ ] 设计 Y.Doc 结构：layers, elements, strokes, comments
  - [ ] Awareness（光标/选中/用户名/颜色）
  - [ ] 离线编辑 + 上线自动合并；重连增量同步
  - [ ] 快照/回放（时间旅行）与版本清理
- **[M3 图片/资源]**
  - [ ] 粘贴/拖拽图片，压缩/缩略图/惰性加载
  - [ ] 选择框/旋转/缩放/层级、批量操作
  - [ ] 资源上传策略（直传/分片）与安全校验
- **[M4 评论/权限]**
  - [ ] 评论锚点绑定元素与线程化讨论、@提及
  - [ ] 权限模型：只读/可评审/可编辑；临时分享链接
  - [ ] 通知与活动流（可选）
- **[M5 性能/稳定性]**
  - [ ] OffscreenCanvas + Worker 绘制管线（降级到主线程）
  - [ ] 视窗裁剪（仅渲染可见区域）与对象池
  - [ ] 帧率监控/内存监控与压测脚本
- **[M6 导出/发布]**
  - [ ] PNG/SVG/PDF 导出（带透明/倍率/区域）
  - [ ] 生产部署/灰度/回滚方案

## 性能指标（SLO）
- 绘制交互 95p < 16ms；首屏可交互 < 2.5s；断网连续编辑 30min 可合并无冲突。

## 验收标准
- 多浏览器/多端同时编辑无冲突；图片/评论与图形正确绑定；导出内容与画布一致。

## 风险与应对
- [数据膨胀] 定期快照+GC；[网络抖动] 本地预测+重放；[浏览器限制] 大图资源分片/压缩。
