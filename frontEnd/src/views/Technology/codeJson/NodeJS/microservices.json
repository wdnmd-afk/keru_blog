{
  "basicArchitecture": {
    "title": "å¾®æœåŠ¡åŸºæœ¬æ¶æ„",
    "language": "javascript",
    "code": "// ç”¨æˆ·æœåŠ¡ (User Service)\nconst express = require('express')\nconst app = express()\n\napp.use(express.json())\n\n// ç”¨æˆ·ç›¸å…³API\napp.get('/users/:id', async (req, res) => {\n  try {\n    const user = await getUserById(req.params.id)\n    res.json(user)\n  } catch (error) {\n    res.status(500).json({ error: error.message })\n  }\n})\n\napp.post('/users', async (req, res) => {\n  try {\n    const user = await createUser(req.body)\n    res.status(201).json(user)\n  } catch (error) {\n    res.status(400).json({ error: error.message })\n  }\n})\n\napp.listen(3001, () => {\n  console.log('ç”¨æˆ·æœåŠ¡è¿è¡Œåœ¨ç«¯å£ 3001')\n})\n\n// è®¢å•æœåŠ¡ (Order Service)\nconst orderApp = express()\n\norderApp.use(express.json())\n\n// è®¢å•ç›¸å…³API\norderApp.get('/orders/:id', async (req, res) => {\n  try {\n    const order = await getOrderById(req.params.id)\n    res.json(order)\n  } catch (error) {\n    res.status(500).json({ error: error.message })\n  }\n})\n\norderApp.post('/orders', async (req, res) => {\n  try {\n    // è°ƒç”¨ç”¨æˆ·æœåŠ¡éªŒè¯ç”¨æˆ·\n    const userResponse = await fetch(`http://user-service:3001/users/${req.body.userId}`)\n    if (!userResponse.ok) {\n      return res.status(400).json({ error: 'ç”¨æˆ·ä¸å­˜åœ¨' })\n    }\n    \n    const order = await createOrder(req.body)\n    res.status(201).json(order)\n  } catch (error) {\n    res.status(400).json({ error: error.message })\n  }\n})\n\norderApp.listen(3002, () => {\n  console.log('è®¢å•æœåŠ¡è¿è¡Œåœ¨ç«¯å£ 3002')\n})"
  },
  "serviceDiscovery": {
    "title": "æœåŠ¡å‘ç°",
    "language": "javascript",
    "code": "// æœåŠ¡æ³¨å†Œä¸­å¿ƒ\nclass ServiceRegistry {\n  constructor() {\n    this.services = new Map()\n  }\n  \n  // æ³¨å†ŒæœåŠ¡\n  register(serviceName, serviceInfo) {\n    if (!this.services.has(serviceName)) {\n      this.services.set(serviceName, [])\n    }\n    \n    this.services.get(serviceName).push({\n      ...serviceInfo,\n      registeredAt: new Date(),\n      lastHeartbeat: new Date()\n    })\n    \n    console.log(`æœåŠ¡æ³¨å†Œ: ${serviceName} - ${serviceInfo.host}:${serviceInfo.port}`)\n  }\n  \n  // å‘ç°æœåŠ¡\n  discover(serviceName) {\n    const instances = this.services.get(serviceName) || []\n    // è¿‡æ»¤å¥åº·çš„æœåŠ¡å®ä¾‹\n    return instances.filter(instance => {\n      const timeSinceHeartbeat = Date.now() - instance.lastHeartbeat.getTime()\n      return timeSinceHeartbeat < 30000 // 30ç§’å†…æœ‰å¿ƒè·³\n    })\n  }\n  \n  // å¿ƒè·³æ£€æµ‹\n  heartbeat(serviceName, serviceId) {\n    const instances = this.services.get(serviceName) || []\n    const instance = instances.find(i => i.id === serviceId)\n    if (instance) {\n      instance.lastHeartbeat = new Date()\n    }\n  }\n  \n  // æ³¨é”€æœåŠ¡\n  unregister(serviceName, serviceId) {\n    const instances = this.services.get(serviceName) || []\n    const index = instances.findIndex(i => i.id === serviceId)\n    if (index !== -1) {\n      instances.splice(index, 1)\n      console.log(`æœåŠ¡æ³¨é”€: ${serviceName} - ${serviceId}`)\n    }\n  }\n}\n\n// æœåŠ¡å®ä¾‹\nclass ServiceInstance {\n  constructor(serviceName, host, port) {\n    this.serviceName = serviceName\n    this.host = host\n    this.port = port\n    this.id = `${serviceName}-${Date.now()}`\n    this.registry = new ServiceRegistry()\n  }\n  \n  // å¯åŠ¨æœåŠ¡\n  start() {\n    // æ³¨å†ŒæœåŠ¡\n    this.registry.register(this.serviceName, {\n      id: this.id,\n      host: this.host,\n      port: this.port,\n      status: 'healthy'\n    })\n    \n    // å®šæœŸå‘é€å¿ƒè·³\n    this.heartbeatInterval = setInterval(() => {\n      this.registry.heartbeat(this.serviceName, this.id)\n    }, 10000)\n    \n    console.log(`æœåŠ¡å¯åŠ¨: ${this.serviceName} on ${this.host}:${this.port}`)\n  }\n  \n  // åœæ­¢æœåŠ¡\n  stop() {\n    if (this.heartbeatInterval) {\n      clearInterval(this.heartbeatInterval)\n    }\n    this.registry.unregister(this.serviceName, this.id)\n    console.log(`æœåŠ¡åœæ­¢: ${this.serviceName}`)\n  }\n}\n\n// ä½¿ç”¨ç¤ºä¾‹\nconst userService = new ServiceInstance('user-service', 'localhost', 3001)\nconst orderService = new ServiceInstance('order-service', 'localhost', 3002)\n\nuserService.start()\norderService.start()"
  },
  "apiGateway": {
    "title": "APIç½‘å…³",
    "language": "javascript",
    "code": "// APIç½‘å…³å®ç°\nconst express = require('express')\nconst httpProxy = require('http-proxy-middleware')\nconst rateLimit = require('express-rate-limit')\nconst jwt = require('jsonwebtoken')\n\nconst app = express()\n\n// æœåŠ¡é…ç½®\nconst services = {\n  'user-service': 'http://localhost:3001',\n  'order-service': 'http://localhost:3002',\n  'product-service': 'http://localhost:3003'\n}\n\n// ä¸­é—´ä»¶\napp.use(express.json())\n\n// é€Ÿç‡é™åˆ¶\nconst limiter = rateLimit({\n  windowMs: 15 * 60 * 1000, // 15åˆ†é’Ÿ\n  max: 100 // é™åˆ¶æ¯ä¸ªIP 100ä¸ªè¯·æ±‚\n})\napp.use('/api/', limiter)\n\n// JWTè®¤è¯ä¸­é—´ä»¶\nconst authenticateToken = (req, res, next) => {\n  const authHeader = req.headers['authorization']\n  const token = authHeader && authHeader.split(' ')[1]\n  \n  if (!token) {\n    return res.status(401).json({ error: 'ç¼ºå°‘è®¿é—®ä»¤ç‰Œ' })\n  }\n  \n  jwt.verify(token, process.env.JWT_SECRET, (err, user) => {\n    if (err) {\n      return res.status(403).json({ error: 'æ— æ•ˆçš„è®¿é—®ä»¤ç‰Œ' })\n    }\n    req.user = user\n    next()\n  })\n}\n\n// è´Ÿè½½å‡è¡¡å™¨\nclass LoadBalancer {\n  constructor() {\n    this.currentIndex = 0\n  }\n  \n  // è½®è¯¢ç®—æ³•\n  roundRobin(instances) {\n    if (instances.length === 0) return null\n    \n    const instance = instances[this.currentIndex]\n    this.currentIndex = (this.currentIndex + 1) % instances.length\n    return instance\n  }\n  \n  // éšæœºç®—æ³•\n  random(instances) {\n    if (instances.length === 0) return null\n    const index = Math.floor(Math.random() * instances.length)\n    return instances[index]\n  }\n}\n\nconst loadBalancer = new LoadBalancer()\n\n// åŠ¨æ€è·¯ç”±\napp.use('/api/:service/*', authenticateToken, (req, res, next) => {\n  const serviceName = req.params.service\n  const serviceUrl = services[serviceName]\n  \n  if (!serviceUrl) {\n    return res.status(404).json({ error: 'æœåŠ¡æœªæ‰¾åˆ°' })\n  }\n  \n  // åˆ›å»ºä»£ç†\n  const proxy = httpProxy.createProxyMiddleware({\n    target: serviceUrl,\n    changeOrigin: true,\n    pathRewrite: {\n      [`^/api/${serviceName}`]: ''\n    },\n    onError: (err, req, res) => {\n      console.error('ä»£ç†é”™è¯¯:', err)\n      res.status(500).json({ error: 'æœåŠ¡æš‚æ—¶ä¸å¯ç”¨' })\n    },\n    onProxyReq: (proxyReq, req, res) => {\n      // æ·»åŠ è¯·æ±‚å¤´\n      proxyReq.setHeader('X-User-ID', req.user.id)\n      proxyReq.setHeader('X-Request-ID', generateRequestId())\n    }\n  })\n  \n  proxy(req, res, next)\n})\n\n// å¥åº·æ£€æŸ¥\napp.get('/health', (req, res) => {\n  res.json({ status: 'healthy', timestamp: new Date().toISOString() })\n})\n\n// ç”Ÿæˆè¯·æ±‚ID\nfunction generateRequestId() {\n  return Math.random().toString(36).substring(2, 15)\n}\n\napp.listen(3000, () => {\n  console.log('APIç½‘å…³è¿è¡Œåœ¨ç«¯å£ 3000')\n})"
  },
  "messageQueue": {
    "title": "æ¶ˆæ¯é˜Ÿåˆ—é€šä¿¡",
    "language": "javascript",
    "code": "// ä½¿ç”¨Redisä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—\nconst redis = require('redis')\nconst { EventEmitter } = require('events')\n\nclass MessageQueue extends EventEmitter {\n  constructor() {\n    super()\n    this.publisher = redis.createClient()\n    this.subscriber = redis.createClient()\n    this.setupSubscriber()\n  }\n  \n  // å‘å¸ƒæ¶ˆæ¯\n  async publish(channel, message) {\n    const payload = {\n      id: this.generateId(),\n      timestamp: new Date().toISOString(),\n      data: message\n    }\n    \n    await this.publisher.publish(channel, JSON.stringify(payload))\n    console.log(`æ¶ˆæ¯å‘å¸ƒåˆ° ${channel}:`, payload.id)\n  }\n  \n  // è®¢é˜…æ¶ˆæ¯\n  async subscribe(channel, handler) {\n    await this.subscriber.subscribe(channel)\n    this.on(channel, handler)\n    console.log(`è®¢é˜…é¢‘é“: ${channel}`)\n  }\n  \n  // è®¾ç½®è®¢é˜…è€…\n  setupSubscriber() {\n    this.subscriber.on('message', (channel, message) => {\n      try {\n        const payload = JSON.parse(message)\n        this.emit(channel, payload)\n      } catch (error) {\n        console.error('æ¶ˆæ¯è§£æé”™è¯¯:', error)\n      }\n    })\n  }\n  \n  generateId() {\n    return Math.random().toString(36).substring(2, 15)\n  }\n}\n\n// ç”¨æˆ·æœåŠ¡ - å‘å¸ƒç”¨æˆ·åˆ›å»ºäº‹ä»¶\nconst userServiceMQ = new MessageQueue()\n\nclass UserService {\n  async createUser(userData) {\n    try {\n      // åˆ›å»ºç”¨æˆ·\n      const user = await this.saveUser(userData)\n      \n      // å‘å¸ƒç”¨æˆ·åˆ›å»ºäº‹ä»¶\n      await userServiceMQ.publish('user.created', {\n        userId: user.id,\n        email: user.email,\n        name: user.name\n      })\n      \n      return user\n    } catch (error) {\n      console.error('ç”¨æˆ·åˆ›å»ºå¤±è´¥:', error)\n      throw error\n    }\n  }\n  \n  async saveUser(userData) {\n    // æ¨¡æ‹Ÿä¿å­˜ç”¨æˆ·åˆ°æ•°æ®åº“\n    return {\n      id: Date.now(),\n      ...userData,\n      createdAt: new Date()\n    }\n  }\n}\n\n// é‚®ä»¶æœåŠ¡ - è®¢é˜…ç”¨æˆ·åˆ›å»ºäº‹ä»¶\nconst emailServiceMQ = new MessageQueue()\n\nclass EmailService {\n  constructor() {\n    this.setupEventHandlers()\n  }\n  \n  async setupEventHandlers() {\n    // è®¢é˜…ç”¨æˆ·åˆ›å»ºäº‹ä»¶\n    await emailServiceMQ.subscribe('user.created', this.handleUserCreated.bind(this))\n  }\n  \n  async handleUserCreated(event) {\n    try {\n      console.log('å¤„ç†ç”¨æˆ·åˆ›å»ºäº‹ä»¶:', event.id)\n      \n      // å‘é€æ¬¢è¿é‚®ä»¶\n      await this.sendWelcomeEmail(event.data.email, event.data.name)\n      \n      console.log(`æ¬¢è¿é‚®ä»¶å·²å‘é€ç»™: ${event.data.email}`)\n    } catch (error) {\n      console.error('é‚®ä»¶å‘é€å¤±è´¥:', error)\n    }\n  }\n  \n  async sendWelcomeEmail(email, name) {\n    // æ¨¡æ‹Ÿå‘é€é‚®ä»¶\n    return new Promise(resolve => {\n      setTimeout(() => {\n        console.log(`ğŸ“§ å‘é€æ¬¢è¿é‚®ä»¶åˆ° ${email}`)\n        resolve()\n      }, 1000)\n    })\n  }\n}\n\n// ä½¿ç”¨ç¤ºä¾‹\nconst userService = new UserService()\nconst emailService = new EmailService()\n\n// åˆ›å»ºç”¨æˆ·ï¼Œè‡ªåŠ¨è§¦å‘é‚®ä»¶å‘é€\nuserService.createUser({\n  name: 'å¼ ä¸‰',\n  email: 'zhangsan@example.com'\n})"
  }
}
